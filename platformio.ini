[env:heltec_wifi_lora_32_v3]
platform = espressif32
board = heltec_wifi_lora_32_V3
framework = arduino

; ============================================================================
; CONFIGURACIÓN DE COMPILACIÓN OPTIMIZADA
; ============================================================================
build_flags = 
    ; Hardware Heltec V3 específico
    -DHELTEC_WIFI_LORA_32_V3=1
    -DARDUINO_HELTEC_WIFI_LORA_32_V3
    
    ; Configuración USB CDC para ESP32-S3
    -DARDUINO_USB_CDC_ON_BOOT=0
    -DARDUINO_USB_MODE=1
    -DCONFIG_TINYUSB_CDC_ENABLED=1
    -DCONFIG_ESP_CONSOLE_USB_CDC=1

    ; Debug y Logging
    -DCORE_DEBUG_LEVEL=5
    -DCONFIG_ARDUHAL_LOG_DEFAULT_LEVEL=5
    -DCONFIG_ARDUHAL_LOG_DEFAULT_LEVEL_VERBOSE=1
    -DCONFIG_ARDUHAL_ESP_LOG=1
    -DCONFIG_ARDUHAL_LOG_COLORS=1
    
    ; Optimización de tamaño
    -Os
    
    ; Definiciones de pines Heltec V3
    -DLORA_NSS=8
    -DLORA_RST=12
    -DLORA_DIO1=14
    -DLORA_BUSY=13
    -DLORA_SCK=9
    -DLORA_MISO=11
    -DLORA_MOSI=10
    -DOLED_SDA=17
    -DOLED_SCL=18
    -DOLED_RST=21
    -DLED_PIN=35
    -DBUZZER_PIN=7
    -DVBAT_PIN=1
    -DGPS_RX_PIN=3
    -DGPS_TX_PIN=4
    -DPRG_BUTTON=0
    -DVEXT_ENABLE=36
    -DVEXT_ON_VALUE=0  ; IMPORTANTE: 0 (LOW) activa VEXT en Heltec V3
    
    ; Configuración del proyecto
    -DFIRMWARE_VERSION=\"3.0.0\"
    -DMANUFACTURER=\"BuenaCabra\"
    -DSERIAL_BAUD=115200
    
    ; Configuración LoRaWAN
    -DLORAWAN_REGION=915
    -DLORAWAN_PORT_GPS=2
    -DTX_INTERVAL_NORMAL=60000
    
    ; Persistencia de datos
    -DUSE_PREFERENCES=1
    
    ; Optimización RadioLib (excluir módulos no usados)
    -DRADIOLIB_EXCLUDE_CC1101=1
    -DRADIOLIB_EXCLUDE_NRF24=1
    -DRADIOLIB_EXCLUDE_RF69=1
    -DRADIOLIB_EXCLUDE_SX1231=1
    -DRADIOLIB_EXCLUDE_SX1233=1
    -DRADIOLIB_EXCLUDE_SI443X=1
    -DRADIOLIB_EXCLUDE_RFM2X=1
    -DRADIOLIB_EXCLUDE_AFSK=1
    -DRADIOLIB_EXCLUDE_AX25=1
    -DRADIOLIB_EXCLUDE_BELL=1
    -DRADIOLIB_EXCLUDE_MORSE=1
    -DRADIOLIB_EXCLUDE_RTTY=1
    -DRADIOLIB_EXCLUDE_SSTV=1
    -DRADIOLIB_EXCLUDE_HELLSCHREIBER=1
    -DRADIOLIB_EXCLUDE_PAGER=1
    -DRADIOLIB_EXCLUDE_DIRECT_RECEIVE=1
    -DRADIOLIB_EXCLUDE_APRS=1
    -DRADIOLIB_EXCLUDE_FSK4=1

; ============================================================================
; LIBRERÍAS NECESARIAS
; ============================================================================
lib_deps = 
    ; RadioLib para SX1262/LoRaWAN
    jgromes/RadioLib@^6.6.0
    
    ; GPS
    mikalhart/TinyGPSPlus@^1.0.3
    
    ; Display OLED
    thingpulse/ESP8266 and ESP32 OLED driver for SSD1306 displays@^4.4.0
    
    ; JSON para configuración
    bblanchon/ArduinoJson@^6.21.3

; ============================================================================
; MONITOR SERIAL MEJORADO Y CORREGIDO
; ============================================================================
monitor_speed = 115200
; Buscar automáticamente el puerto o especificar manualmente
monitor_port = COM3
monitor_rts = 0
monitor_dtr = 0

; IMPORTANTE: Comentar monitor_raw para evitar conflicto con filters
; monitor_raw = yes

; Filtros para mejor debugging
monitor_filters = 
    default
    time
    colorize
    esp32_exception_decoder

; ============================================================================
; UPLOAD Y PARTICIONES
; ============================================================================
upload_speed = 921600
board_build.partitions = huge_app.csv
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = qio

; ============================================================================
; CONFIGURACIÓN ADICIONAL
; ============================================================================
; Scripts opcionales (descomentar si se necesitan)
; extra_scripts = 
;     pre:scripts/pre_build.py
;     post:scripts/post_build.py

; Configuración de debugging
debug_tool = esp-builtin
debug_init_break = tbreak setup
debug_speed = 20000
